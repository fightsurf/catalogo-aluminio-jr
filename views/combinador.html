<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî¢ Combinador de Kits ‚Äî Alum√≠nio JR</title>
<style>
  body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 20px; color: #333; }
  h1 { color: #222; }
  h2 { color: #444; margin-top: 25px; }
  button { background: #007bff; color: #fff; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; }
  button:hover { background: #0056b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 25px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #007bff; color: white; cursor: pointer; }
  tr:nth-child(even) { background: #f2f2f2; }
  .produto-linha { margin-bottom: 6px; }
</style>
</head>
<body>

<h1>üî¢ Combinador de Kits ‚Äî Alum√≠nio JR</h1>

<p>Marque os itens obrigat√≥rios e proibidos abaixo. O sistema gerar√° automaticamente as combina√ß√µes poss√≠veis de kits.</p>

<h2>Itens dispon√≠veis</h2>
<div id="lista-produtos">Carregando produtos...</div>

<button id="gerar">Gerar Combina√ß√µes</button>

<h2>Resultados</h2>
<table id="tabela-resultados">
  <thead>
    <tr>
      <th data-coluna="total">Pre√ßo Total (R$)</th>
      <th data-coluna="medio">Pre√ßo M√©dio (R$)</th>
      <th>Itens</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function carregarProdutos() {
  const res = await fetch("https://catalogo-aluminio-jr.onrender.com/api/produtos");
  const produtos = await res.json();
  const lista = document.getElementById("lista-produtos");
  lista.innerHTML = "";

  produtos.forEach(p => {
    const div = document.createElement("div");
    div.className = "produto-linha";
    div.innerHTML = `
      <label><input type="checkbox" class="chk-obrigatorio" data-id="${p.id}"> obrigat√≥rio</label>
      <label><input type="checkbox" class="chk-proibido" data-id="${p.id}"> proibido</label>
      <b>${p.nome}</b> ‚Äî R$ ${p.preco.toFixed(2)}
    `;
    lista.appendChild(div);
  });
}

function gerarCombinacoes(produtos, obrigatorios, proibidos) {
  const combinacoes = [];

  // Simula√ß√£o simples: gera combina√ß√µes de at√© 5 produtos v√°lidos
  const validos = produtos.filter(p => !proibidos.includes(p.id));

  for (let i = 0; i < validos.length; i++) {
    const grupo = [validos[i]];
    obrigatorios.forEach(o => {
      if (!grupo.find(g => g.id === o.id)) grupo.push(o);
    });

    const total = grupo.reduce((s, g) => s + g.preco, 0);
    const medio = total / grupo.length;

    combinacoes.push({
      total: total.toFixed(2),
      medio: medio.toFixed(2),
      itens: grupo.map(g => g.nome).join(" - ")
    });
  }

  return combinacoes;
}

function atualizarTabela(dados) {
  const tbody = document.querySelector("#tabela-resultados tbody");
  tbody.innerHTML = "";

  dados.forEach(l => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.total}</td>
      <td>${l.medio}</td>
      <td>${l.itens}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Ordena√ß√£o clic√°vel
document.querySelectorAll("th[data-coluna]").forEach(th => {
  th.addEventListener("click", () => {
    const coluna = th.dataset.coluna;
    const tbody = document.querySelector("#tabela-resultados tbody");
    const linhas = Array.from(tbody.querySelectorAll("tr"));
    const asc = !th.classList.contains("asc");
    document.querySelectorAll("th").forEach(el => el.classList.remove("asc", "desc"));
    th.classList.add(asc ? "asc" : "desc");

    linhas.sort((a, b) => {
      const va = parseFloat(a.children[coluna === "total" ? 0 : 1].innerText);
      const vb = parseFloat(b.children[coluna === "total" ? 0 : 1].innerText);
      return asc ? va - vb : vb - va;
    });

    linhas.forEach(l => tbody.appendChild(l));
  });
});

document.getElementById("gerar").addEventListener("click", async () => {
  const res = await fetch("https://catalogo-aluminio-jr.onrender.com/api/produtos");
  const produtos = await res.json();

  const obrigatorios = produtos.filter(p => document.querySelector(`.chk-obrigatorio[data-id="${p.id}"]`)?.checked);
  const proibidos = produtos.filter(p => document.querySelector(`.chk-proibido[data-id="${p.id}"]`)?.checked);

  if (obrigatorios.length === 0) {
    alert("Selecione pelo menos um item obrigat√≥rio.");
    return;
  }

  const combinacoes = gerarCombinacoes(produtos, obrigatorios, proibidos);
  atualizarTabela(combinacoes);
});

carregarProdutos();
</script>

</body>
</html>
