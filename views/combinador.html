<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚙️ Combinador de Kits — Alumínio JR</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
  h1 { color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
  th { background-color: #e8e8e8; }
  tr:nth-child(even) { background-color: #f5f5f5; }
  tr:hover { background: #dfe9ff; cursor: pointer; }
  .config { margin-bottom: 20px; }
  input[type="number"] { width: 60px; }
  button { margin-top: 15px; padding: 10px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background-color: #0056b3; }
</style>
</head>
<body>

<h1>⚙️ Combinador de Kits — Alumínio JR</h1>

<div class="config">
  <label><b>Tamanho máximo do kit:</b> <input type="number" id="tamKit" value="9" min="1" max="20"></label>
  <label><b>Preço médio máximo (R$):</b> <input type="number" id="precoMax" value="15" step="0.01"></label>
  <label><input type="checkbox" id="permitirRepeticao" checked> Permitir repetição de itens</label>
</div>

<table id="tabelaItens">
  <thead>
    <tr>
      <th>Produto</th>
      <th>Preço (R$)</th>
      <th>Obrigatório</th>
      <th>Qtd</th>
      <th>Proibido</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="gerarCombinacoes()">Gerar combinações</button>

<h2>Resultados</h2>
<table id="tabelaResultados">
  <thead>
    <tr>
      <th onclick="ordenarPor('total')">Preço Total</th>
      <th onclick="ordenarPor('medio')">Preço Médio</th>
      <th>Itens (com preços)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let produtos = [];
let combinacoes = [];
let ordenacao = 'medio';

async function carregarProdutos() {
  const res = await fetch('/api/produtos');
  produtos = await res.json();
  renderTabelaItens();
}

function renderTabelaItens() {
  const tbody = document.querySelector('#tabelaItens tbody');
  tbody.innerHTML = produtos.map(p => `
    <tr>
      <td style="text-align:left">${p.nome}</td>
      <td>${p.preco.toFixed(2)}</td>
      <td><input type="checkbox" class="chk-obrig" data-id="${p.id}"></td>
      <td><input type="number" class="qtd-obrig" data-id="${p.id}" value="1" min="1" max="10"></td>
      <td><input type="checkbox" class="chk-proib" data-id="${p.id}"></td>
    </tr>
  `).join('');
}

function gerarCombinacoes() {
  const tamKit = parseInt(document.getElementById('tamKit').value);
  const precoMax = parseFloat(document.getElementById('precoMax').value);
  const permitirRepeticao = document.getElementById('permitirRepeticao').checked;

  const obrigInputs = [...document.querySelectorAll('.chk-obrig:checked')];
  const obrigIds = obrigInputs.map(c => c.dataset.id);
  const obrigQtds = obrigInputs.map(c => parseInt(document.querySelector('.qtd-obrig[data-id="'+c.dataset.id+'"]').value));

  const obrigatorios = [];
  obrigIds.forEach((id, i) => {
    const produto = produtos.find(p => p.id === id);
    if (produto) for (let j = 0; j < obrigQtds[i]; j++) obrigatorios.push(produto);
  });

  const proibIds = [...document.querySelectorAll('.chk-proib:checked')].map(c => c.dataset.id);
  const proibidos = new Set(proibIds);
  const disponiveis = produtos.filter(p => !proibidos.has(p.id) && !obrigIds.includes(p.id)).sort((a, b) => a.preco - b.preco);

  combinacoes = [];
  const maxComb = 1000;

  for (let i = 0; i < maxComb; i++) {
    const itens = [...obrigatorios];
    const usados = new Set(obrigIds);
    while (itens.length < tamKit) {
      const escolha = disponiveis[Math.floor(Math.random() * disponiveis.length)];
      if (!permitirRepeticao && usados.has(escolha.id)) continue;
      itens.push(escolha);
      usados.add(escolha.id);
      const total = itens.reduce((s, p) => s + p.preco, 0);
      const medio = total / itens.length;
      if (medio > precoMax) { itens.pop(); usados.delete(escolha.id); break; }
    }
    const total = itens.reduce((s, p) => s + p.preco, 0);
    const medio = total / itens.length;
    if (medio <= precoMax && itens.length === tamKit) combinacoes.push({ total, medio, itens });
  }

  combinacoes.sort((a, b) => a[ordenacao] - b[ordenacao]);
  renderTabelaResultados();
}

function renderTabelaResultados() {
  const tbody = document.querySelector('#tabelaResultados tbody');
  tbody.innerHTML = combinacoes.map((c, i) => `
    <tr onclick="copiarWhatsApp(${i})">
      <td>R$ ${c.total.toFixed(2)}</td>
      <td>R$ ${c.medio.toFixed(2)}</td>
      <td>${c.itens.map(p => `${p.nome} (R$ ${p.preco.toFixed(2)})`).join(' — ')}</td>
    </tr>
  `).join('');
}

function copiarWhatsApp(index) {
  const kit = combinacoes[index];
  const qtdItens = kit.itens.length;
  const itensLista = kit.itens.map(p => `- ${p.nome} (x1)`).join('\n');
  const texto = `*${qtdItens} itens selecionados:*\n${itensLista}\n\n*Preço final do kit: R$ ${kit.total.toFixed(2)}*\n*Preço médio por item: R$ ${kit.medio.toFixed(2)}*`;
  navigator.clipboard.writeText(texto);
  alert("✅ Kit copiado no formato WhatsApp!");
}

function ordenarPor(tipo) {
  ordenacao = tipo;
  combinacoes.sort((a, b) => a[tipo] - b[tipo]);
  renderTabelaResultados();
}

carregarProdutos();
</script>

</body>
</html>
