<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üí∞ Combina√ß√µes ‚Äî Kits Feirinha</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
  h1 { color: #333; }
  h2 { color: #555; margin-top: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #007bff; color: white; cursor: pointer; }
  tr:hover { background: #eef; }
  .categoria { background: #e9e9e9; font-weight: bold; text-align: left; }
  button { margin-top: 10px; padding: 10px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background-color: #0056b3; }
  input[type="number"] { width: 70px; }
  input[type="checkbox"] { transform: scale(1.2); }
  #config { background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; }
</style>
</head>
<body>

<h1>üí∞ Gerador de Combina√ß√µes ‚Äî Kits Feirinha</h1>

<div id="config">
  <label><b>Qtd. m√°x. de itens:</b> <input type="number" id="tamKit" value="5" min="1"></label>
  <label style="margin-left:10px"><b>M√©dia m√°xima (R$):</b> <input type="number" id="precoMax" value="15" step="0.01"></label>
  <label style="margin-left:10px"><input type="checkbox" id="permitirRepeticao" checked> Permitir repeti√ß√£o</label>
  <button id="btnGerar">Gerar Combina√ß√µes</button>
</div>

<h2>üîπ Itens Dispon√≠veis</h2>
<table id="tabelaItens">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Categoria</th>
      <th>Pre√ßo (R$)</th>
      <th>Obrigat√≥rio</th>
      <th>Qtd.</th>
      <th>Proibido</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>üîπ Resultados</h2>
<table id="tabelaResultados">
  <thead>
    <tr>
      <th onclick="ordenarPor('total')">Pre√ßo Total</th>
      <th onclick="ordenarPor('medio')">Pre√ßo M√©dio</th>
      <th>Itens</th>
    </tr>
  </thead>
  <tbody><tr><td colspan="3">Aguardando gera√ß√£o...</td></tr></tbody>
</table>

<script>
let produtos = [];
let combinacoes = [];
let ordenacao = 'medio';

async function carregarProdutos() {
  try {
    const res = await fetch('/api/produtos');
    produtos = await res.json();
  } catch {
    document.querySelector('#tabelaItens tbody').innerHTML = `<tr><td colspan="6">Erro ao carregar produtos.</td></tr>`;
    return;
  }

  const ordemCategorias = [
    "LINHA COMUM COM TAMPA DE ALUM√çNIO",
    "LINHA COMUM COM TAMPA DE VIDRO",
    "LINHA ANTIADERENTE SEM TAMPA",
    "LINHA ANTIADERENTE COM TAMPA DE VIDRO"
  ];

  produtos.sort((a, b) => {
    const ai = ordemCategorias.indexOf((a.categoria || "").toUpperCase());
    const bi = ordemCategorias.indexOf((b.categoria || "").toUpperCase());
    return (ai - bi) || a.nome.localeCompare(b.nome);
  });

  renderTabelaItens();
}

function renderTabelaItens() {
  const tbody = document.querySelector('#tabelaItens tbody');
  tbody.innerHTML = '';

  let categoriaAtual = '';

  produtos.forEach(p => {
    if (p.categoria !== categoriaAtual) {
      categoriaAtual = p.categoria;
      const rowCat = document.createElement('tr');
      rowCat.innerHTML = `<td colspan="6" class="categoria">${categoriaAtual}</td>`;
      tbody.appendChild(rowCat);
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left">${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.preco?.toFixed(2) || '0.00'}</td>
      <td><input type="checkbox" class="chk-obrig" data-id="${p.id}"></td>
      <td><input type="number" class="qtd-obrig" data-id="${p.id}" value="1" min="1" max="10"></td>
      <td><input type="checkbox" class="chk-proib" data-id="${p.id}"></td>
    `;
    tbody.appendChild(tr);
  });
}

function gerarCombinacoes() {
  const tamKit = parseInt(document.getElementById('tamKit').value);
  const precoMax = parseFloat(document.getElementById('precoMax').value);
  const permitirRepeticao = document.getElementById('permitirRepeticao').checked;

  const obrigatorios = [];
  document.querySelectorAll('.chk-obrig:checked').forEach(chk => {
    const id = chk.dataset.id;
    const qtdInput = document.querySelector(`.qtd-obrig[data-id="${id}"]`);
    const qtd = parseInt(qtdInput?.value || 1);
    const produto = produtos.find(p => p.id === id);
    if (produto) for (let i = 0; i < qtd; i++) obrigatorios.push(produto);
  });

  const proibidos = new Set([...document.querySelectorAll('.chk-proib:checked')].map(c => c.dataset.id));
  const disponiveis = produtos.filter(p => !proibidos.has(p.id));
  disponiveis.sort((a, b) => a.preco - b.preco);

  const baseTotal = obrigatorios.reduce((s, p) => s + p.preco, 0);
  const faltantes = tamKit - obrigatorios.length;

  if (faltantes <= 0) {
    alert("O n√∫mero de obrigat√≥rios j√° excede o tamanho do kit.");
    return;
  }

  combinacoes = [];
  let testadas = 0;
  let melhorTentativa = null;

  // üîπ Estrat√©gia: preencher faltantes com combina√ß√µes das pe√ßas mais baratas poss√≠veis
  function tentarCombinacao() {
    const itens = [...obrigatorios];
    let total = baseTotal;
    for (let i = 0; i < faltantes; i++) {
      const p = disponiveis[i % disponiveis.length];
      itens.push(p);
      total += p.preco;
    }
    const medio = total / tamKit;
    if (!melhorTentativa || medio < melhorTentativa.medio)
      melhorTentativa = { total, medio, itens };
    if (medio <= precoMax) combinacoes.push({ total, medio, itens });
  }

  // üîπ Testa diversas varia√ß√µes trocando o mix das pe√ßas mais baratas
  for (let i = 0; i < disponiveis.length; i++) {
    for (let j = i; j < disponiveis.length; j++) {
      const itens = [...obrigatorios];
      let total = baseTotal;
      for (let k = 0; itens.length < tamKit; k++) {
        const index = permitirRepeticao ? (k % disponiveis.length) : (i + k);
        const p = disponiveis[index];
        if (!p) break;
        itens.push(p);
        total += p.preco;
      }
      const medio = total / tamKit;
      if (!melhorTentativa || medio < melhorTentativa.medio)
        melhorTentativa = { total, medio, itens };
      if (medio <= precoMax) combinacoes.push({ total, medio, itens });
      testadas++;
      if (combinacoes.length >= 1000) break;
    }
    if (combinacoes.length >= 1000) break;
  }

  const tbodyRes = document.querySelector('#tabelaResultados tbody');
  tbodyRes.innerHTML = '';

  if (combinacoes.length === 0) {
    let msg = `‚ö†Ô∏è Nenhum kit encontrado at√© R$ ${precoMax.toFixed(2)} de m√©dia.<br>Testadas ${testadas} combina√ß√µes.`;
    if (melhorTentativa)
      msg += `<br><br>üü¢ Melhor tentativa: ${melhorTentativa.itens.length} itens ‚Äî total R$ ${melhorTentativa.total.toFixed(2)} (m√©dia R$ ${melhorTentativa.medio.toFixed(2)})<br>${melhorTentativa.itens.map(p => p.nome + " (" + p.preco.toFixed(2) + ")").join(" ‚Äî ")}`;
    tbodyRes.innerHTML = `<tr><td colspan="3">${msg}</td></tr>`;
  } else {
    combinacoes.sort((a, b) => a[ordenacao] - b[ordenacao]);
    renderTabelaResultados();
    tbodyRes.insertAdjacentHTML('beforeend', `<tr><td colspan="3">(${combinacoes.length} combina√ß√µes v√°lidas encontradas)</td></tr>`);
  }
}

function renderTabelaResultados() {
  const tbody = document.querySelector('#tabelaResultados tbody');
  tbody.innerHTML = combinacoes.map((c, i) => `
    <tr onclick="copiarWhatsApp(${i})">
      <td>R$ ${c.total.toFixed(2)}</td>
      <td>R$ ${c.medio.toFixed(2)}</td>
      <td>${c.itens.map(p => `${p.nome} (${p.preco.toFixed(2)})`).join(' ‚Äî ')}</td>
    </tr>
  `).join('');
}

function copiarWhatsApp(index) {
  const kit = combinacoes[index];
  const qtdItens = kit.itens.length;
  const itensLista = kit.itens.map(p => `- ${p.nome} (x1)`).join('\n');
  const texto = `*${qtdItens} itens selecionados:*\n${itensLista}\n\n*Pre√ßo final do kit: R$ ${kit.total.toFixed(2)}*\n*Pre√ßo m√©dio por item: R$ ${kit.medio.toFixed(2)}*`;
  navigator.clipboard.writeText(texto);
  alert("‚úÖ Kit copiado no formato WhatsApp!");
}

function ordenarPor(tipo) {
  ordenacao = tipo;
  combinacoes.sort((a, b) => a[tipo] - b[tipo]);
  renderTabelaResultados();
}

document.getElementById('btnGerar').addEventListener('click', gerarCombinacoes);
carregarProdutos();
</script>

</body>
</html>
