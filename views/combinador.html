<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üí∞ Combina√ß√µes ‚Äî Kits Feirinha</title>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
  h1 { color: #333; }
  h2 { color: #555; margin-top: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #007bff; color: white; cursor: pointer; }
  tr:hover { background: #eef; }
  .categoria { background: #e9e9e9; font-weight: bold; text-align: left; }
  button { margin-top: 10px; padding: 10px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background-color: #0056b3; }
  input[type="number"] { width: 70px; }
  input[type="checkbox"] { transform: scale(1.2); }
  #config { background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; }
</style>
</head>

<body>

<h1>üí∞ Gerador de Combina√ß√µes ‚Äî Kits Feirinha</h1>

<div id="config">
  <label><b>Qtd. m√°x. de itens:</b>
    <input type="number" id="tamKit" value="5" min="1">
  </label>

  <label style="margin-left:10px"><b>M√©dia m√°xima (R$):</b>
    <input type="number" id="precoMax" value="15" step="0.01">
  </label>

  <button id="btnGerar">Gerar Combina√ß√µes</button>
</div>

<h2>üîπ Itens Dispon√≠veis</h2>
<table id="tabelaItens">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Categoria</th>
      <th>Pre√ßo (R$)</th>
      <th>Obrigat√≥rio</th>
      <th>Proibido</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>üîπ Resultados</h2>
<table id="tabelaResultados">
  <thead>
    <tr>
      <th onclick="ordenarPor('total')">Pre√ßo Total</th>
      <th onclick="ordenarPor('medio')">Pre√ßo M√©dio</th>
      <th>Itens</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="3">Aguardando gera√ß√£o...</td></tr>
  </tbody>
</table>

<script>
let produtos = [];
let combinacoes = [];
let ordenacao = 'medio';

async function carregarProdutos() {
  const res = await fetch('/api/produtos');
  produtos = await res.json();
  renderTabelaItens();
}

/* ========= TABELA DE ITENS (AGRUPADA POR CATEGORIA) ========= */
function renderTabelaItens() {
  const tbody = document.querySelector('#tabelaItens tbody');
  tbody.innerHTML = '';

  // Agrupar por categoria
  const grupos = {};
  produtos.forEach(p => {
    const cat = p.categoria || 'SEM CATEGORIA';
    if (!grupos[cat]) grupos[cat] = [];
    grupos[cat].push(p);
  });

  // Ordem das categorias (alfab√©tica)
  const categorias = Object.keys(grupos).sort();

  categorias.forEach(cat => {
    // Cabe√ßalho da categoria (UMA VEZ)
    tbody.insertAdjacentHTML(
      'beforeend',
      `<tr><td colspan="5" class="categoria">${cat}</td></tr>`
    );

    // Produtos da categoria
    grupos[cat]
      .sort((a, b) => a.nome.localeCompare(b.nome))
      .forEach(p => {
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td style="text-align:left">${p.nome}</td>
            <td>${p.categoria}</td>
            <td>${p.preco.toFixed(2)}</td>
            <td><input type="checkbox" class="chk-obrig" data-id="${p.id}"></td>
            <td><input type="checkbox" class="chk-proib" data-id="${p.id}"></td>
          </tr>
        `);
      });
  });
}

/* ========= GERA√á√ÉO DE COMBINA√á√ïES (COMBINA√á√ÉO SIMPLES + PODA) ========= */
function gerarCombinacoes() {
  const tamKit = parseInt(document.getElementById('tamKit').value);
  const precoMax = parseFloat(document.getElementById('precoMax').value);

  const obrigatorios = [];
  document.querySelectorAll('.chk-obrig:checked').forEach(c => {
    const p = produtos.find(x => x.id === c.dataset.id);
    if (p) obrigatorios.push(p);
  });

  const proibidos = new Set(
    [...document.querySelectorAll('.chk-proib:checked')].map(c => c.dataset.id)
  );

  const disponiveis = produtos
    .filter(p => !proibidos.has(p.id))
    .sort((a, b) => a.preco - b.preco);

  const baseTotal = obrigatorios.reduce((s, p) => s + p.preco, 0);
  const faltantes = tamKit - obrigatorios.length;

  combinacoes = [];

  function backtrack(inicio, kit, soma) {
    if (kit.length === faltantes) {
      const itens = [...obrigatorios, ...kit];
      const total = soma + baseTotal;
      const medio = total / tamKit;

      if (medio <= precoMax) {
        combinacoes.push({ total, medio, itens });
      }
      return;
    }

    for (let i = inicio; i < disponiveis.length; i++) {
      const p = disponiveis[i];
      const novaSoma = soma + p.preco;
      const mediaParcial =
        (novaSoma + baseTotal) /
        (obrigatorios.length + kit.length + 1);

      if (mediaParcial > precoMax) break;

      kit.push(p);
      backtrack(i + 1, kit, novaSoma);
      kit.pop();
    }
  }

  backtrack(0, [], 0);

  combinacoes.sort((a, b) => a[ordenacao] - b[ordenacao]);
  renderResultados();
}

/* ========= RESULTADOS ========= */
function renderResultados() {
  const tbody = document.querySelector('#tabelaResultados tbody');

  if (combinacoes.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">‚ö†Ô∏è Nenhuma combina√ß√£o encontrada.</td></tr>`;
    return;
  }

  tbody.innerHTML = combinacoes.map(c => `
    <tr>
      <td>R$ ${c.total.toFixed(2)}</td>
      <td>R$ ${c.medio.toFixed(2)}</td>
      <td>${c.itens.map(p => p.nome).join(' - ')}</td>
    </tr>
  `).join('');

  tbody.insertAdjacentHTML(
    'beforeend',
    `<tr><td colspan="3">(${combinacoes.length} combina√ß√µes encontradas)</td></tr>`
  );
}

/* ========= ORDENA√á√ÉO ========= */
function ordenarPor(tipo) {
  ordenacao = tipo;
  combinacoes.sort((a, b) => a[tipo] - b[tipo]);
  renderResultados();
}

document.getElementById('btnGerar').addEventListener('click', gerarCombinacoes);
carregarProdutos();
</script>

</body>
</html>
