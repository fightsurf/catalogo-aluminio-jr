<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚙️ Combinador de Kits — Alumínio JR</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
  h1 { color: #333; }
  h2 { color: #555; margin-top: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
  th { background-color: #e8e8e8; cursor: pointer; }
  tr:nth-child(even) { background-color: #f5f5f5; }
  .config, .paginacao { margin-top: 15px; }
  select, input { margin: 5px; padding: 5px; }
  button { padding: 10px 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background-color: #0056b3; }
  .checkboxes { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; }
  .checkboxes label { width: 48%; }
  .aviso { background: #ffe0e0; padding: 10px; margin-top: 15px; border: 1px solid #f88; display: none; }
</style>
</head>
<body>

<h1>⚙️ Combinador de Kits — Alumínio JR</h1>

<div class="config">
  <label><b>Tamanho do kit:</b> <input type="number" id="tamKit" value="5" min="1" max="10"></label>
  <label><b>Preço médio máximo (R$):</b> <input type="number" id="precoMax" value="17" step="0.01"></label>
</div>

<h2>Itens obrigatórios</h2>
<div id="itensObrigatorios" class="checkboxes"></div>

<h2>Itens proibidos</h2>
<div id="itensProibidos" class="checkboxes"></div>

<button onclick="gerarCombinacoes()">Gerar combinações</button>
<div class="aviso" id="aviso"></div>

<h2>Resultados</h2>
<div class="paginacao">
  <label>Itens por página:
    <select id="itensPorPagina" onchange="renderTabela()">
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100" selected>100</option>
    </select>
  </label>
  <span id="paginacaoInfo"></span>
</div>

<table id="tabelaResultados">
  <thead>
    <tr>
      <th onclick="ordenarPor('total')">Preço Total</th>
      <th onclick="ordenarPor('medio')">Preço Médio</th>
      <th>Itens (com preços)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="paginacao">
  <button onclick="paginaAnterior()">« Anterior</button>
  <button onclick="proximaPagina()">Próximo »</button>
</div>

<script>
let produtos = [];
let combinacoes = [];
let paginaAtual = 1;
let ordenacao = 'medio';

async function carregarProdutos() {
  const res = await fetch('/api/produtos');
  produtos = await res.json();
  renderCheckboxes();
}

function renderCheckboxes() {
  const obrig = document.getElementById('itensObrigatorios');
  const proib = document.getElementById('itensProibidos');
  obrig.innerHTML = '';
  proib.innerHTML = '';
  produtos.forEach(p => {
    const checkO = document.createElement('label');
    const checkP = document.createElement('label');
    checkO.innerHTML = `<input type="checkbox" data-id="${p.id}" class="chk-obrig"> ${p.nome}`;
    checkP.innerHTML = `<input type="checkbox" data-id="${p.id}" class="chk-proib"> ${p.nome}`;
    obrig.appendChild(checkO);
    proib.appendChild(checkP);
  });
}

function gerarCombinacoes() {
  const tamKit = parseInt(document.getElementById('tamKit').value);
  const precoMax = parseFloat(document.getElementById('precoMax').value);

  const obrigIds = [...document.querySelectorAll('.chk-obrig:checked')].map(c => c.dataset.id);
  const proibIds = [...document.querySelectorAll('.chk-proib:checked')].map(c => c.dataset.id);

  const obrigatorios = produtos.filter(p => obrigIds.includes(p.id));
  const proibidos = new Set(proibIds);
  const disponiveis = produtos.filter(p => !proibidos.has(p.id));

  if (obrigatorios.length > tamKit) {
    alert('⚠️ Quantidade de obrigatórios maior que o tamanho do kit!');
    return;
  }

  const maxComb = 10000;
  combinacoes = [];

  function combinar(arr, k, prefix = []) {
    if (combinacoes.length >= maxComb) return;
    if (prefix.length === k) {
      const itens = [...obrigatorios, ...prefix];
      const total = itens.reduce((s, p) => s + p.preco, 0);
      const medio = total / itens.length;
      if (medio <= precoMax) {
        combinacoes.push({ total, medio, itens });
      }
      return;
    }
    for (let i = 0; i < arr.length; i++) {
      combinar(arr.slice(i + 1), k, [...prefix, arr[i]]);
    }
  }

  const k = tamKit - obrigatorios.length;
  combinar(disponiveis.filter(p => !obrigIds.includes(p.id)), k);

  if (combinacoes.length === 0) {
    alert('Nenhum kit válido encontrado com essas condições.');
    return;
  }

  if (combinacoes.length >= maxComb) {
    document.getElementById('aviso').style.display = 'block';
    document.getElementById('aviso').innerText = '⚠️ Limite de 10.000 combinações atingido — resultados parciais.';
  } else {
    document.getElementById('aviso').style.display = 'none';
  }

  combinacoes.sort((a, b) => a.medio - b.medio);
  paginaAtual = 1;
  renderTabela();
}

function renderTabela() {
  const tbody = document.querySelector('#tabelaResultados tbody');
  const itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
  const inicio = (paginaAtual - 1) * itensPorPagina;
  const fim = inicio + itensPorPagina;
  const pagina = combinacoes.slice(inicio, fim);

  tbody.innerHTML = pagina.map(c => `
    <tr>
      <td>R$ ${c.total.toFixed(2)}</td>
      <td>R$ ${c.medio.toFixed(2)}</td>
      <td>${c.itens.map(p => `${p.nome} (R$ ${p.preco.toFixed(2)})`).join(' — ')}</td>
    </tr>
  `).join('');

  const totalPaginas = Math.ceil(combinacoes.length / itensPorPagina);
  document.getElementById('paginacaoInfo').innerText =
    `Página ${paginaAtual} de ${totalPaginas} (${combinacoes.length} kits encontrados)`;
}

function paginaAnterior() {
  if (paginaAtual > 1) { paginaAtual--; renderTabela(); }
}
function proximaPagina() {
  const itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
  const totalPaginas = Math.ceil(combinacoes.length / itensPorPagina);
  if (paginaAtual < totalPaginas) { paginaAtual++; renderTabela(); }
}
function ordenarPor(tipo) {
  ordenacao = tipo;
  combinacoes.sort((a, b) => a[tipo] - b[tipo]);
  paginaAtual = 1;
  renderTabela();
}

carregarProdutos();
</script>

</body>
</html>
