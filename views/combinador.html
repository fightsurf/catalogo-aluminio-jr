<script>
let produtos = [];
let combinacoes = [];
let ordenacao = 'medio';

async function carregarProdutos() {
  const res = await fetch('/api/produtos');
  produtos = await res.json();

  const ordemCategorias = [
    "LINHA COMUM COM TAMPA DE ALUMÍNIO",
    "LINHA COMUM COM TAMPA DE VIDRO",
    "LINHA ANTIADERENTE SEM TAMPA",
    "LINHA ANTIADERENTE COM TAMPA DE VIDRO"
  ];

  produtos.sort((a, b) => {
    const ai = ordemCategorias.indexOf(a.categoria.toUpperCase());
    const bi = ordemCategorias.indexOf(b.categoria.toUpperCase());
    return (ai - bi) || a.nome.localeCompare(b.nome);
  });

  renderTabelaItens();
}

function renderTabelaItens() {
  const tbody = document.querySelector('#tabelaItens tbody');
  tbody.innerHTML = '';

  let categoriaAtual = '';

  produtos.forEach(p => {
    if (p.categoria !== categoriaAtual) {
      categoriaAtual = p.categoria;
      const rowCat = document.createElement('tr');
      rowCat.innerHTML = `<td colspan="6" class="categoria">${categoriaAtual}</td>`;
      tbody.appendChild(rowCat);
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:left">${p.nome}</td>
      <td>${p.categoria}</td>
      <td>${p.preco.toFixed(2)}</td>
      <td><input type="checkbox" class="chk-obrig" data-id="${p.id}"></td>
      <td><input type="number" class="qtd-obrig" data-id="${p.id}" value="1" min="1" max="10"></td>
      <td><input type="checkbox" class="chk-proib" data-id="${p.id}"></td>
    `;
    tbody.appendChild(tr);
  });
}

function gerarCombinacoes() {
  const tamKit = parseInt(document.getElementById('tamKit').value);
  const precoMax = parseFloat(document.getElementById('precoMax').value);
  const permitirRepeticao = document.getElementById('permitirRepeticao').checked;

  const obrigatorios = [];
  document.querySelectorAll('.chk-obrig:checked').forEach(chk => {
    const id = chk.dataset.id;
    const qtdInput = document.querySelector(`.qtd-obrig[data-id="${id}"]`);
    const qtd = parseInt(qtdInput?.value || 1);
    const produto = produtos.find(p => p.id === id);
    if (produto) for (let i = 0; i < qtd; i++) obrigatorios.push(produto);
  });

  const proibidos = new Set([...document.querySelectorAll('.chk-proib:checked')].map(c => c.dataset.id));
  const obrigIds = obrigatorios.map(p => p.id);
  const disponiveis = produtos.filter(p => !proibidos.has(p.id) && !obrigIds.includes(p.id));

  combinacoes = [];
  const maxComb = 2000;

  for (let i = 0; i < maxComb; i++) {
    const itens = [...obrigatorios];
    const usados = new Set(obrigIds);

    while (itens.length < tamKit) {
      const escolha = disponiveis[Math.floor(Math.random() * disponiveis.length)];
      if (!permitirRepeticao && usados.has(escolha.id)) continue;
      itens.push(escolha);
      usados.add(escolha.id);
    }

    const total = itens.reduce((s, p) => s + p.preco, 0);
    const medio = total / itens.length;

    if (medio <= precoMax)
      combinacoes.push({ total, medio, itens });
  }

  if (combinacoes.length === 0) {
    alert("⚠️ Nenhuma combinação encontrada com esses parâmetros.");
  } else {
    combinacoes.sort((a, b) => a[ordenacao] - b[ordenacao]);
    renderTabelaResultados();
  }
}

function renderTabelaResultados() {
  const tbody = document.querySelector('#tabelaResultados tbody');
  tbody.innerHTML = combinacoes.map((c, i) => `
    <tr onclick="copiarWhatsApp(${i})">
      <td>R$ ${c.total.toFixed(2)}</td>
      <td>R$ ${c.medio.toFixed(2)}</td>
      <td>${c.itens.map(p => `${p.nome} (${p.categoria}) — R$ ${p.preco.toFixed(2)}`).join(' — ')}</td>
    </tr>
  `).join('');
}

function copiarWhatsApp(index) {
  const kit = combinacoes[index];
  const qtdItens = kit.itens.length;
  const itensLista = kit.itens.map(p => `- ${p.nome} (x1)`).join('\n');
  const texto = `*${qtdItens} itens selecionados:*\n${itensLista}\n\n*Preço final do kit: R$ ${kit.total.toFixed(2)}*\n*Preço médio por item: R$ ${kit.medio.toFixed(2)}*`;
  navigator.clipboard.writeText(texto);
  alert("✅ Kit copiado no formato WhatsApp!");
}

function ordenarPor(tipo) {
  ordenacao = tipo;
  combinacoes.sort((a, b) => a[tipo] - b[tipo]);
  renderTabelaResultados();
}

document.getElementById('btnGerar').addEventListener('click', gerarCombinacoes);
carregarProdutos();
</script>
